import json
import os
from consul import Consul
from pyutil.consul import defaults
import time
from pyutil.program.functool import throttle

class Degrade:
    def __init__(self,dc="lf",demotion_key="profile_server_test"):
        self.consul_client = Consul(host=defaults.agent_host, port=defaults.agent_port, consistency='stale',dc=dc)
        self.dc = dc
        self.demotion_key = demotion_key
    @throttle(wait=60000)#one minute only one request
    def get_demotion(self):
        index,data = self.consul_client.kv.get('config/' + self.demotion_key)
        if data:
            if data.has_key('Value'):
                return data['Value']
        return None
if __name__ == '__main__':
    degrade = Degrade(demotion_key="profile_server_test")
    print degrade.get_demotion()
    time.sleep(1)
    print degrade.get_demotion()

# coding: utf-8
import requests, json
from requests.auth import HTTPBasicAuth

def init_token(app_id, secret):
    return HTTPBasicAuth(app_id, secret)

def get(url, token):
    headers = {'Content-Type': 'application/json'}
    r = requests.get(url, auth=token, headers=headers, verify=False)
    return json.loads(r.text)

def post(url, token, payload):
    headers = {'Content-Type': 'application/json'}
    r = requests.post(url, auth=token, headers=headers, data=json.dumps(payload), verify=False)
    return json.loads(r.text)

def send_text_message(token, employee_ids, agent_id, content):
    payload = {"employee_ids":employee_ids,"agent_id":agent_id,"type":"text","content":{"content":content}}
    return post("https://ee.byted.org/ratak/dingtalk/messages/", token, payload)

def send_text_message_channel(token, channel_id, content):
    payload = {"channel_id":channel_id,"type":"text","content":{"content":content}}
    return post("https://ee.byted.org/ratak/dingtalk/channels/%s/messages/" % channel_id, token, payload)

def send_oa_message(token, employee_ids, agent_id, content):
    payload = {
        "employee_ids":employee_ids,
        "agent_id":agent_id,
        "type":"oa",
        "content": content
    }
    return post("https://ee.byted.org/ratak/dingtalk/messages/", token, payload)

def get_employee_by_name(token, ldap_name):
    employee = get("https://ee.byted.org/ratak/employees/%s/" % ldap_name, token)
    return employee

def send_text_message_by_name(token, name, agent_id, content):
    employee = get_employee_by_name(token, name)
    if not employee:
        return False
    send_text_message(token, [employee['id']], agent_id, content)

def send_oa_message_by_name(token, name, agent_id, content):
    employee = get_employee_by_name(token, name)
    if not employee:
        return False
    send_oa_message(token, [employee['id']], agent_id, content)

if __name__ == '__main__':
    token = init_token('31', 'A8A5552F1D6A4C84A1CF8F063AF8BC6E')
    print send_text_message_by_name(token, 'hetianyi', 22750773, 'test2')

# coding=utf-8


def tracing(request):
    import json
    from pyutil.program.tracing import get_current_span
    ctx = get_current_span().context
    if hasattr(ctx, 'trace_id'):
        # 会放到body的data-trace属性，由于js不支持超过52bit的整数，因此转为str
        trace_info = dict(trace_id=str(ctx.trace_id), span_id=str(ctx.span_id))
    else:
        trace_info = {}
    return {'trace_info': json.dumps(trace_info)}


def user(request):
    context_extras = {}
    if hasattr(request, 'user'):
        context_extras['user'] = request.user
    return context_extras


def kani_permissions(request):
    context_extras = {}
    if not hasattr(request, 'user'):
        return {}
    context_extras['perms'] = request.user.get_all_permissions()
    return context_extras

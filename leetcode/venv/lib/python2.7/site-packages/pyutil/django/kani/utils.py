# coding=utf8
from __future__ import unicode_literals
from django.conf import settings as django_settings
from pyutil.kani.utils import KaniSystemHandler, KaniSystemConfError


def get_kani_django_conf():
    options = getattr(django_settings, 'KANI_CONFIG', {})
    app_id = options.get('app_id')
    app_secret = options.get('app_secret')
    admins = options.get('admins')
    if not (app_id and app_secret and admins):
        raise KaniSystemConfError(options)
    return app_id, app_secret, admins


def dj_kani_system_handler():
    app_id, app_secret, _ = get_kani_django_conf()
    return KaniSystemHandler(app_id, app_secret)


def kani_perms_to_dj_perms(perms):
    perms_ = set()
    for resource, actions in perms.items():
        actions = set(actions)
        app_label = resource[:resource.index('.')]
        resource_name = resource[resource.index('.') + 1:]
        if any(s in actions for s in ['all', u'admin']):
            actions.update(['add', 'change', 'delete'])
        perms_.update(
            set(['%s.%s_%s' % (app_label, action, resource_name) for action in actions])
        )
    return perms_


def get_admin_function_kani_key(af_id):
    return '_function.%s' % af_id

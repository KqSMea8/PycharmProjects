# coding=utf8
from django.contrib.auth.models import User
from django.dispatch import receiver
from django_auth_ldap import backend

@receiver(backend.populate_user)
def make_random_password(sender, **kwargs):
    '''
    django_auth_ldap.backend 创建django用户时会默认创建一个unusable的密码，
    而django对密码是unusable的情况下需要先修改一个密码然后才可以分配权限，
    我们使用ldap认证机制后用户不需要知道自己的django密码，为方便使用我们
    截获 django_auth_ldap.backend.populate_user 发出的信号，若用户是django
    初次创建则将为其设置一个随机密码。 
    '''
    user = kwargs['user']
    if not user.has_usable_password():
        passwd = User.objects.make_random_password()
        user.set_password(passwd)
    return True

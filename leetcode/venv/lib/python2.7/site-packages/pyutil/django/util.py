# -*- coding: utf-8 -*-
import re

SIMPLE_IP_REGEX = r'[0-9]{1,}\.[0-9]{1,}\.[0-9]{1,}\.[0-9]{1,}$'
PRIVATE_IP_REGEX = r'^192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[01])\.'


def get_ip(request):
    """
    离用户最近的公网ip，获取顺序Client-IP、X-Forwarded-for、Remote-Addr
    不可信，适合用来做ip2city
    :param request:
    :return:
    """
    client_ip = request.META.get('HTTP_CLIENT_IP')
    if client_ip:
        return client_ip

    ips = request.META.get('HTTP_X_FORWARDED_FOR')
    if ips:
        for ip in ips.split(','):
            ip = ip.strip()
            if re.match(SIMPLE_IP_REGEX, ip) and not re.match(PRIVATE_IP_REGEX, ip):
                return ip
    return request.META.get('REMOTE_ADDR', '')


def django_version_greater_than(version_str):
    import django
    from distutils.version import StrictVersion
    current_version_str = '.'.join(str(x) for x in django.VERSION[:3])
    return StrictVersion(current_version_str) > StrictVersion(version_str)


def get_real_ip(request):
    """
    连我们接入nginx的ip，适合用来记录、追查
    动态加速转发时会设置Ali-CDN-Real-IP
    :param request:
    :return:
    """
    return request.META.get('HTTP_ALI_CDN_REAL_IP') or request.META.get('HTTP_X_REAL_IP', '')

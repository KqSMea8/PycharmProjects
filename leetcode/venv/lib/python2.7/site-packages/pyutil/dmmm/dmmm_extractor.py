#!/usr/bin/env python
import threading
from thrift.transport import TSocket, TTransport
from thrift.protocol import TBinaryProtocol
from pyutil.thrift.transport import TSocketPool
from ss_thrift_gen.dmmm import DMMMExtractService
from ss_thrift_gen.dmmm.ttypes import Request

class DMMMExtractor(threading.local):

    def __init__(self, host, port):
        transport = TSocketPool.TSocketPool(host, port)
        transport = TTransport.TBufferedTransport(transport)
        protocol = TBinaryProtocol.TBinaryProtocol(transport)
        self.client = DMMMExtractService.Client(protocol)
        self.client.transport = transport

    def extract(self, gid, keywords):
        req = Request(gid=gid, keywords=keywords)
        try:
            self.client.transport.open()
            return self.client.extract(req)
        finally:
            self.client.transport.close()
        return None

    def extract_cluster_keyword(self, gid, keywords):
        req = Request(gid=gid, keywords=keywords)
        try:
            self.client.transport.open()
            return self.client.extract_cluster_keyword(req)
        finally:
            self.client.transport.close()
        return None

if __name__ == '__main__':
    extractor = DMMMExtractor('10.4.31.20', 8333)
    keywords = {60162: 8.744314193725586, 2612246: 8.783395767211914, 48006: 10.079520225524902, 2422794: 11.747523307800293, 39895: 7.902435779571533, 423549581: 10.212509155273438, 2655502: 12.359713554382324, 76559: 12.030921936035156, 827920: 8.240823745727539, 2427025: 10.449666976928711, 2787474: 10.212509155273438, 343059: 15.946768760681152, 541716: 10.212509155273438, 2623382: 9.3011474609375, 738968: 9.404080390930176, 85531: 43.49671936035156, 16030: 8.143290519714355, 3021488: 9.81217098236084, 2421403: 8.710490226745605, 2462245: 8.523831367492676, 2459943: 11.701516151428223, 115113: 14.843360900878906, 2500271: 9.205326080322266, 23216: 11.43207836151123, 149820: 13.649402618408203, 253885: 8.729374885559082, 3113668: 10.212509155273438, 736968: 8.90366268157959, 3079757: 75.57340240478516, 2448916: 8.992887496948242, 2808013: 9.560307502746582, 387027: 8.714188575744629, 2406286: 9.257271766662598, 124153: 8.339476585388184, 435160: 10.212509155273438, 2476763: 8.278343200683594, 3499613: 10.212509155273438, 2463198: 8.187021255493164, 2426975: 9.366913795471191, 8523744: 17.67519760131836, 6832226: 10.212509155273438, 2499044: 7.96340799331665, 53094: 8.067455291748047, 460134: 8.170035362243652, 2426856: 14.503684043884277, 2608269: 9.263631820678711, 2542577: 8.849554061889648, 619305: 12.268834114074707, 2674324: 9.08199405670166, 38650: 17.936439514160156}
    gid = 6274773334773973250
    print extractor.extract(gid, keywords)

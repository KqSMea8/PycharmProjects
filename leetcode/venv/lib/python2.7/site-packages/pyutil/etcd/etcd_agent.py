# -*-coding: utf-8 -*-

import os
import json
import urllib3

import pyutil.program.metrics2 as metrics
import pyutil.ttlogging as logger

ETCD_METRICS_PREFIX = 'etcd'
ETCD_AGENT_CANNOT_CONNECT = 'agent.cannot.connect'

agent_host = "127.0.0.1"
agent_port = 2150

ping_timeout = 0.05
ping_succ_code = 0


env_host = os.getenv("HOST_IP_ADDR", None)
if env_host:
    agent_host = env_host
metrics.define_counter(ETCD_AGENT_CANNOT_CONNECT, prefix=ETCD_METRICS_PREFIX)


def get_agent_addr():
    return agent_host, agent_port


def ping_agent():
    ping_url = "http://" + agent_host + ":" + str(agent_port) + "/agent/ping"
    try:
        manager = urllib3.PoolManager(num_pools=1)
        agent_resp = manager.request('GET', ping_url, timeout=ping_timeout, retries=0)
        resp = agent_resp.data.decode('utf-8')
        r = json.loads(resp)
        if r.get("errorCode", None) is ping_succ_code:
            return True
    except Exception as ex:
        metrics.emit_counter(ETCD_AGENT_CANNOT_CONNECT, 1, ETCD_METRICS_PREFIX)
        logger.warn("etcd: ping agent failed, pingURL=%s, err=%s" % (ping_url, ex))
    return False

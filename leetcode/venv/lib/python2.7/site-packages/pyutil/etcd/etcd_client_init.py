# -*-coding: utf-8 -*-
import pyutil.ttlogging as logger
import etcd_client
import etcd_agent

etcd_client_rw = etcd_client.EtcdClient()
_has_configed = False


def config_etcd_client(conf):
    """
    使用etcd client并不需要调用该函数，etcd client默认测试环境下使用测试集群，线上环境使用线上集群。
    如果想在测试使用线上集群，可以调用本函数传入线上配置
    """
    global etcd_client_rw
    global _has_configed
    if _has_configed:
        return
    host_port_list = conf.get_values("etcd_host_port")
    if len(host_port_list[0]) == 0:
        logger.info("etcd: conf does not contains valid etcd host_port, use default one")
        return
    etcd_client_rw = etcd_client.EtcdClient(conf)
    _has_configed = True

def reset_etcd_client():
    """
    fork进程后reset一下
    :return:
    """
    global etcd_client_rw
    etcd_client_rw = etcd_client.EtcdClient()

def get_etcd_client_reader():
    _ETCD_HOST_PORT = "etcd_host_port"

    class EtcdConf(object):
        def __init__(self, host, port):
            self.local_conf = {_ETCD_HOST_PORT: [host+":"+str(port)]}

        def get_values(self, key):
            return self.local_conf.get(key)

    if etcd_agent.ping_agent():
        host, port = etcd_agent.get_agent_addr()
        return etcd_client.EtcdClient(conf=EtcdConf(host, port))
    else:
        logger.info("etcd: connect to proxy directly")

    return etcd_client.EtcdClient()
etcd_client_reader = get_etcd_client_reader()

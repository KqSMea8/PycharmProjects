#coding: utf-8

from datetime import datetime

from snakebite.client import HAClient
from snakebite.namenode import Namenode

from .python_util import sizeof_fmt

HDFS_NAMENODES = {
    'kingkong': '10.4.161.2:5060,10.4.161.66:5060',
    'haruna': '10.6.128.152:5060,10.6.129.12:5060'
}

def get_hdfs_client(fs_name):
    namenodes = []
    cluster = HDFS_NAMENODES[fs_name]
    for namenode in cluster.split(','):
        host, port = namenode.split(':')
        namenodes.append(Namenode(host, int(port)))
    return HAClient(namenodes)


def parse_hdfs_uri(uri):
    if uri.startswith('hdfs://'):
        uri = uri[7:]
        split = uri.split('/', 1)
        fs = split[0]
        path = '/' + split[1]
    else:
        fs = ''
        path = uri
    return fs, path


def get_path_meta(client, paths):
    if not isinstance(paths, (tuple, list)):
        paths = [paths]
    result = []
    for item in client.count(paths):
        path = item['path']
        stat = client.stat([path])
        modification_time = datetime.fromtimestamp(stat['modification_time']/1000)
        result.append({'size': sizeof_fmt(item['length']), 'files_count': item['fileCount'], 'modification_time': modification_time})
    return result

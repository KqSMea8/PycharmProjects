#!/usr/bin/env python
#coding=utf8
import urllib2,zlib
from pyutil.text.util import smart_decode
MAX_ARTICLE_FILESIZE = 1024 * 1024
HTTP_HEADERS = ['Cookie', 'Content-Type', 'User-Agent', 'Referer', 'Accept-Encoding']
class DirectDownloader(object):
    '''
        send http request to get the html content directly
    '''
    @staticmethod
    def download(url, proxy='', timeout=20, **headers):
        '''
        url - utf8
        dinfo - all values are utf8 str
        return - status(str), body(str), msg(dict)
        '''
        request = urllib2.Request(url)
        headers = {k: v for k, v in headers.iteritems() if k in HTTP_HEADERS}
        for k, v in headers.iteritems():
            request.add_header(k, v)
        req_proxy={}
        if proxy:
            proxy_type = 'https' if 'https://' in url else 'http'
            req_proxy[proxy_type] = proxy
        opener = urllib2.build_opener(urllib2.ProxyHandler(req_proxy))
        response = None
        status = 'fail'
        data = ''
        dinfo = {}
        try:
            response = opener.open(request, timeout=timeout)
            code = response.getcode()
            if code != 200:
                dinfo = {'status_code': code}
            else:
                dinfo['mime_type'] = response.info().gettype()
                dinfo['content_length'] = int(response.headers.get('content-length') or 0)
                data = response.read()
                if response.headers.get('content-encoding') == 'gzip':
                    decomp = zlib.decompressobj(16+zlib.MAX_WBITS)
                    data = decomp.decompress(data)
                    data = smart_decode(data)
                if url != response.geturl():
                    dinfo['redirect_url'] = response.geturl()
                status = 'ok'
        except Exception as e:
            dinfo = {'error_msg': e}
        finally:
            if response:
                response.close()
        return status, data, dinfo

if __name__ == '__main__':
    url = 'http://finance.ifeng.com/a/20150918/13981811_0.shtml'
    status, data, dinfo = DirectDownloader.download(url)
    print status, dinfo
    proxy = '10.4.16.31:7035'
    url = 'http://finance.ifeng.com/a/20150918/13981811_0.shtml'
    status, data, dinfo = DirectDownloader.download(url, proxy)
    print status, dinfo
    proxy = '10.100.4.68:3128'
    url = 'https://twitter.com/TopTenUnsigned/status/644378875028344832'
    status, data, dinfo = DirectDownloader.download(url, proxy)
    print status, data, dinfo

def use_face_uri(size, face):
    w, h = size
    if w > h:
        return False
    if h / float(w) > 3:
        return False
    if face["face_num"] <= 0:
        return False
    if face["face_num"] > 3:
        return False
    p = face["faces"][0]
    s = (p["right"] - p["left"])*(p["bottom"] - p["top"]) # face area
    if round(s/float(w*h), 4) < 0.001: # face area percent < 0.001 
        return False
    return True

LIST_IMAGE_SIZE = (172.0, 120.0)

def get_list_face_uri(uri, size, face_pos, exp_size=LIST_IMAGE_SIZE):
    params = _cal_params(size, exp_size, face_pos)
    if params:
        return "%s/%s/" % (uri, "_".join([str(p) for p in params]))
    return None

def rnd(s): # round to int
    return int(round(s, 0))

def _cal_params(size, expect_size, face_pos):
    w, h = size
    exp_w, exp_h = expect_size
    p = face_pos
    face_w = p["right"] - p["left"]
    face_h = p["bottom"] - p["top"]
    real_ratio = w / float(h)
    expect_ratio = exp_w / float(exp_h)
    if real_ratio > expect_ratio:
        # width >> height, crop width
        tmp_w = rnd(h * expect_ratio) or 1
        crop_w = w - tmp_w
        # by face left/right padding
        w_padding = w - face_w # without face, the padding we have
        if w_padding - 0.2*face_w < crop_w:
            return False # not enough padding for face
        crop_left = crop_w * (p["left"] / float(w_padding))
        if exp_h > h:
            zoom = 1
        else:
            zoom = round(float(exp_h) / h, 4)
        return (rnd(crop_left), 0, rnd(tmp_w + crop_left), h, zoom)
    else:
        # height >> width, crop height
        tmp_h = rnd(w / expect_ratio) or 1
        crop_h = h - tmp_h
        h_padding = h - face_h
        # by face top/bottom padding
        if h_padding - 0.8*face_h < crop_h:
            return False # not enough padding for face
        crop_top = crop_h * (p["top"] / float(h_padding))
        if p["top"] < crop_top + 0.8*face_h:
            crop_top = p["top"] - 0.8*face_h
        if crop_top < 0: crop_top = 0
        if exp_w > w:
            zoom = 1
        else:
            zoom = round(float(exp_w) / w, 4)
        return (0, rnd(crop_top), w, rnd(tmp_h + crop_top), zoom)


if __name__ == "__main__":
    face_pos = {"top": 258, "right": 377, "bottom": 437, "left": 198}
    print(get_list_face_uri("3832/2816781120", (500, 527), face_pos))
    face_pos["bottom"] = 500
    assert get_list_face_uri("3832/2816781120", (500, 527), face_pos) == None

from PIL import Image

CODE_ORIENTATION = 0x0112
ORIENTATION_TRANS = {  # transpose list, counter clockwise
        1: (),
        2: (Image.FLIP_LEFT_RIGHT,),
        3: (Image.ROTATE_180,),
        4: (Image.FLIP_TOP_BOTTOM,),
        5: (Image.FLIP_LEFT_RIGHT, Image.ROTATE_90),
        6: (Image.ROTATE_270,),
        7: (Image.FLIP_TOP_BOTTOM, Image.ROTATE_90),
        8: (Image.ROTATE_90,),
        }

def get_orientation(image):
    assert isinstance(image, Image.Image), type(image)
    if not hasattr(image, "_getexif"):
        return None
    try:
        exif = image._getexif()
    except:
        return None
    if not exif:
        return None
    return exif.get(CODE_ORIENTATION)

def transpose(image, orientation):
    if not orientation:
        return image
    assert isinstance(image, Image.Image), type(image)
    trans = ORIENTATION_TRANS.get(orientation, ())
    for t in trans:
        image = image.transpose(t)
    return image

def auto_orientate(image, orientation=None):
    return transpose(image, orientation or get_orientation(image))

def need_orientate(image):
    orientation = get_orientation(image)
    return orientation not in (0, 1, None)

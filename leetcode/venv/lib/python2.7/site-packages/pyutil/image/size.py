#encoding=utf8

ALL_SIZES = SIZE_ORIGIN, SIZE_THUMB, SIZE_MEDIUM, SIZE_LARGE = range(4)

THUMB_WIDTH = 120
MEDIUM_WIDTH = 202
LARGE_WIDTH = 640

def get_thumb_height(width, height):
    if height <= 256:
        return height
    return 256

def get_middle_height(width, height):
    if height <= 450:
        return height
    return 350 + int(height) % 100

HEIGHT_FUNC_MAP = {
    SIZE_THUMB: get_thumb_height,
    SIZE_MEDIUM: get_middle_height,
    }

MAX_WIDTH_MAP = {
    SIZE_THUMB: THUMB_WIDTH,
    SIZE_MEDIUM: MEDIUM_WIDTH,
    SIZE_LARGE: LARGE_WIDTH,
    }


def rnd(i):
    return int(round(i, 0)) or 1

def get_size(width, height, size_type, crop_height=True):
    '''
    >>> get_size(10, 50, SIZE_THUMB)
    (10, 50)
    >>> get_size(240, 50, SIZE_THUMB)
    (120, 25)
    >>> get_size(404, 1000, SIZE_MEDIUM)
    (202, 350)
    >>> get_size(404, 50, SIZE_MEDIUM)
    (202, 25)
    >>> get_size(1280, 50, SIZE_LARGE)
    (640, 25)
    >>> get_size(4096, 1024, SIZE_LARGE) # > 3/1, w > 3072
    (3072, 768)
    >>> get_size(1024, 4096, SIZE_LARGE) # < 1/3, w > 480
    (480, 1920)
    '''
    width = int(width or 0)
    height = int(height or 0)

    if size_type == SIZE_LARGE:
        if width / height >= 3 and width >= 3072:
            new_width = 3072
            new_height = float(new_width) / width * height
            return rnd(new_width), rnd(new_height)
        elif height / width >= 3 and width >= 480:
            new_width = 480
            new_height = float(new_width) / width * height
            return rnd(new_width), rnd(new_height)


    max_width = MAX_WIDTH_MAP.get(size_type)
    if not max_width:
        return width, height

    new_width = width
    new_height = height
    if new_width > max_width:
        new_width = max_width
        new_height = float(new_width) / width * height

    height_func = HEIGHT_FUNC_MAP.get(size_type)
    if height_func and crop_height:
        new_height = height_func(new_width, new_height)
    return rnd(new_width), rnd(new_height)


def get_custom_size(width, height, expect_width=None, expect_height=None):
    if expect_width and expect_height:
        return (expect_width, expect_height)

    ratio = height / float(width)
    if expect_width:
        expect_height = int(ratio * expect_width)
    elif expect_height:
        expect_width = int(expect_height / ratio)
    return (expect_width, expect_height)


if __name__ == '__main__':
    print(get_size(50, 50, SIZE_LARGE))
    print(get_size(240, 50, SIZE_THUMB))
    print(get_size(404, 50, SIZE_MEDIUM))
    print(get_size(1280, 50, SIZE_LARGE))
    print(get_size(1024, 4096, SIZE_LARGE))
    print(get_size(4096, 1024, SIZE_LARGE))
    print(get_size(440, 1180, SIZE_THUMB))

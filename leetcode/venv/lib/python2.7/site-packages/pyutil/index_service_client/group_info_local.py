#!/usr/bin/env python
# coding=utf8

import pdb, time, json, msgpack, logging
from pyutil.cache.cache_class import CacheClass
from pyutil.memcache.client import MemcacheClient
from pyutil.program.db import DAL
from pyutil.program.lru import ExpiringLRUCache

from index_service.ttypes import SearchKvReq, SearchKvRsp
from client import ThriftIndexServiceClient

class GroupInfoLocal(object):
    def __init__(self, remote_host, remote_port,  local_host="127.0.0.1", local_port=9988,key_tpl="co_gf_:%s:v1.1", index_name='channel_online_group_info',conn_timeout=0.05, timeout=0.25):
        self.index_service_cli = ThriftIndexServiceClient(remote_host, remote_port, local_host, local_port, timeout)
        self.index_name = index_name
        self.key_tpl = key_tpl

    def pack(self, info):
        ret = msgpack.packb(info)
        return ret

    def unpack(self, raw_value):
        return msgpack.unpackb(raw_value)


    def make_key(self, gid):
        return self.key_tpl % (gid)

    def mget(self, gids, unpack=True):
        ret = {}
        try:
            if len(gids) <= 0:
                return ret
            key_map = {self.make_key(gid):gid for gid in gids}
            req = SearchKvReq()
            req.keys = key_map.keys()
            req.index_name = self.index_name
            rsp = self.index_service_cli.search_kv(req)
            for key, info in rsp.kvs.iteritems():
                gid = key_map[key]
                if unpack:
                    info = self.unpack(info)
                ret[gid] = info
        except Exception as e:
            logging.exception(e)
        return ret

if __name__ == '__main__':
    from pyutil.program.sys_conf import SysConf
    import sys

    sys_conf = SysConf('/opt/tiger/ss_conf/ss')
    group_info_cache = GroupInfoLocal(sys_conf.sort_host_all, 9988,"10.4.16.202", 9988,key_tpl='article_info_v2_%s',index_name="feed_group_info")

    gids = [int(gid) for gid in sys.argv[1:]]

    ret = group_info_cache.mget(gids)
    print ret
    #for gid, info in ret.iteritems():
    #    print gid, info

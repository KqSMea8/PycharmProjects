# -*- coding: utf-8 -*-
import re

from pyutil.lb import client

dc_re = re.compile(r"(\.service\.\w+)$")

def lookup_local(name, timeout=1.0, max_retries=3):    
    name = dc_re.sub("", name)
    request_id, require_client_connect, weight, ttl = [None] * 4
    req = client.build_request(name,
                               request_id,
                               require_client_connect,
                               weight,
                               ttl,
                               require_passive=True)

    i = 0
    while i < max_retries:
        resp, _ = client.request_bootstrap_attempt(req, timeout)
        if resp and resp.transportType == client.CLIENT_CONNECT:
            break
        i += 1
    else:
        raise LookupError("no such %s endpoints" % name)

    host, _, port = resp.endpointAddress.partition(":")
    return host, int(port)

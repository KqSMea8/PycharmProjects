#! /usr/bin/python
#encoding:utf8

import logging, threading
from thrift.transport import TSocket, TTransport
from thrift.protocol import TBinaryProtocol
from pyutil.thrift.transport import SocketPool
from pyutil.program.conf import Conf

from ss.article.lr_server import VWPredict
from ss.article.lr_server.ttypes import GroupScore
from ss.article.lr_server.ttypes import VWPredReq
from ss.article.lr_server.ttypes import VWPredResp
from ss.article.lr_server.ttypes import VWPredReq2
from ss.article.lr_server.ttypes import VWPredResp2
from ss.article.lr_server.ttypes import GroupFeature


class LRServerPredictClient(threading.local):

    def __init__(self, hosts, ports, timeout=0.1, conn_timeout=0.05, retries = 2):
        self._retries = retries
        transport = SocketPool.TSocketPool(hosts, ports, timeout, conn_timeout)
        transport = TTransport.TBufferedTransport(transport)
        protocol = TBinaryProtocol.TBinaryProtocolAccelerated(transport)
        self.client = VWPredict.Client(protocol)
        self.client.transport = transport

    def predict(self, user_feature, group_features, model_type, disturbance=0):
        result = None
        retry = 0
        req = VWPredReq(user_feature, group_features, model_type, disturbance)
        while retry < self._retries:
            try:
                self.client.transport.open()
                result = self.client.predict(req)
            except Exception, tx:
                logging.warning("%s, retry:%d" % (tx.message, retry))
                retry += 1
            finally:
                self.client.transport.close()
            if result:
                return result
        return result


    def predict_new(self, user_feature, group_features, model_type, disturbance=0):
        result = None
        retry = 0
        req = VWPredReq(user_feature, group_features, model_type, disturbance)
        while retry < self._retries:
            try:
                self.client.transport.open()
                result = self.client.predict(req)
            except Exception, tx:
                logging.warning("%s, retry:%d" % (tx.message, retry))
                retry += 1
            finally:
                self.client.transport.close()
            if result:
                return result
        return result

    def predict2(self, user_feature, group_features, model_type, disturbance=0):
        new_group_features = ""
        for gft in group_features:
            new_group_features += "%d#%s$" %(gft.gid, gft.feature)

        req = VWPredReq2(user_feature, new_group_features[:-1], model_type, disturbance)
        retry = 0
        result = None
        while retry < self._retries:
            try:
                self.client.transport.open()
                result = self.client.predict2(req)
            except Exception, tx:
                logging.warning("%s, retry:%d" % (tx.message, retry))
                retry += 1
            finally:
                self.client.transport.close()
            if result:
                break
        if not result:
            return None
        old_rsp = VWPredResp(model_type = result.model_type, return_type = result.return_type, scores=[])
        old_scores = []
        gss = result.scores.split('$')
        for gs in gss:
            if len(gs.strip()) < 1:
                continue
            gid,weight = gs.split('#')
            old_scores.append(GroupScore(gid=int(gid), score=float(weight)))
            print old_scores
        old_rsp.scores.extend(old_scores)
        return old_rsp



#!/usr/bin/env python

from kafka.partitioner import Partitioner
from pyutil.kafka_proxy.kafka_proxy import KafkaProxy
from pyutil.memcache.jenkins import oneatatime
from pyutil.program.conf2 import Conf

class PushPartitioner(Partitioner):
    """
    Implements a partitioner which selects the target partition based on
    the hash of the key
    """
    def partition(self, key, partitions):
        idx = oneatatime(str(key)) % len(partitions)
        return partitions[idx]

def get_push_kafka_proxy(conf, cluster_name, topic, consumer_group=None):
    if conf is None:
        conf = Conf('/opt/tiger/ss_conf/ss/kafka.conf')
    return KafkaProxy(codec="", topic=topic, consumer_group=consumer_group,
        cluster_name=cluster_name, conf=conf, key_hash=True, partitioner=PushPartitioner)


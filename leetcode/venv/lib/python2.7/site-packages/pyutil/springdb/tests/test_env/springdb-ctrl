#!/bin/bash
program=ssdb
curr_dir=$(dirname $0)
nohup_log=$curr_dir/log/nohup.out

function stat {
    #pgrep -x -u $USER $program | xargs -r ps u -p
    for i in $curr_dir/var/$program.*.pid; do
        if [[ -e $i ]]; then
            ps u -p $(cat $i)
        fi
    done
}

function start {
    #bin=/opt/tiger/twemproxy_bin/bin/ssdb-server
    bin=../../../../../ssdb/ssdb-server

    mkdir -p $curr_dir/log $curr_dir/var/master $curr_dir/var/slave

    nohup $bin $curr_dir/conf/ssdb.master.conf 1>>$nohup_log 2>&1 &
    nohup $bin $curr_dir/conf/ssdb.slave.conf 1>>$nohup_log 2>&1 &

    sleep 0.1
    echo "[PROCESS LIST AFTER OPERATION]"
    stat
}

function stop {
    #killall -u $USER $program
    for i in $curr_dir/var/$program.*.pid; do
        if [[ -e $i ]]; then
            kill $(cat $i)
            rm -rf $i
        fi
    done
}

if [ "x$1" == "xstart" ]; then
    stop
    sleep 0.5
    start
elif [ "x$1" == "xstop" ]; then
    stop
elif [ "x$1" == "xrestart" ]; then
    stop
    sleep 0.5
    start
elif [ "x$1" == "xstat" ]; then
    stat
else
    echo "usage: $0 stat|start|stop|restart"
    exit 1
fi


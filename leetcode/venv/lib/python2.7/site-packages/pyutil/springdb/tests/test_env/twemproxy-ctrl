#!/bin/bash
program=twemproxy
curr_dir=$(dirname $0)
nohup_log=$curr_dir/log/nohup.out

function stat {
    #pgrep -x -u $USER $program | xargs -r ps u -p
    for i in $curr_dir/var/$program.*.pid; do
        if [[ -e $i ]]; then
            ps u -p $(cat $i)
        fi
    done
}

function start {
    #bin=/opt/tiger/twemproxy_bin/bin/twemproxy
    bin=../../../../../twemproxy/src/nutcracker
    args="-v 6"

    mkdir -p $curr_dir/log $curr_dir/var

    nohup $bin $args -s 5496 -c $curr_dir/conf/twemproxy.backend-error.yml -o $curr_dir/log/twemproxy.backend-error.log -p $curr_dir/var/$program.backend-error.pid 1>>$nohup_log 2>&1 &
    nohup $bin $args -s 5497 -c $curr_dir/conf/twemproxy.backend-timeout.yml -o $curr_dir/log/twemproxy.backend-timeout.log -p $curr_dir/var/$program.backend-timeout.pid 1>>$nohup_log 2>&1 &
    nohup $bin $args -s 5498 -c $curr_dir/conf/twemproxy.master.yml -o $curr_dir/log/twemproxy.master.log -p $curr_dir/var/$program.master.pid 1>>$nohup_log 2>&1 &
    nohup $bin $args -s 5499 -c $curr_dir/conf/twemproxy.slave.yml -o $curr_dir/log/twemproxy.slave.log -p $curr_dir/var/$program.slave.pid 1>>$nohup_log 2>&1 &

    sleep 0.1
    echo "[PROCESS LIST AFTER OPERATION]"
    stat
}

function stop {
    #killall -u $USER $program
    for i in $curr_dir/var/$program.*.pid; do
        if [[ -e $i ]]; then
            kill $(cat $i) && rm -rf $i
        fi
    done
}

if [ "x$1" == "xstart" ]; then
    stop
    start
elif [ "x$1" == "xstop" ]; then
    stop
elif [ "x$1" == "xrestart" ]; then
    stop
    start
elif [ "x$1" == "xstat" ]; then
    stat
else
    echo "usage: $0 stat|start|stop|restart"
    exit 1
fi


#!/usr/bin/python
#coding: utf-8

from datetime import datetime as dt
from datastore import TableauDatastore 

def put_indicator(metrics, date_time, time_frame='hour', prefix='', overwrite=False, incremental=False):
    '''
        push data into tableaudb

    usage: 
        date_time 和 time_frame 作为组合key，如果date_time 和 time_frame 的取值都相同，则被merge到同一行；
        date_time 和 time_frame 分别标示 统计时间窗口的 起点 和 长度。
        metrics是指标列，如果该指标在表中没有，则自动修改表结构，增加该列；
        prefix会作为前缀跟指标名拼接：【prefix='feed', metrics = {u'read_per_impr': 0.0446}】等效于【prefix='', metrics = {u'feed_read_per_impr': 0.0446}】
        当指标值为大整数，高精度浮点，或者超长字串时，跟存入字段不符，请联系dba修改字段定义；
    '''
    date_time = date_time.strftime('%Y-%m-%d %H:%M:%S')
    dimensions = {'time_frame': time_frame}
    metrics = dict([(prefix and "{}_{}".format(prefix, k) or k, v ) for k, v in metrics.iteritems()])
    td = TableauDatastore('growth', 'indicator_monitor')
    td.put_data(date_time, metrics, dimensions, overwrite, incremental)

if __name__ == '__main__':
    metrics = {u'read_per_impr': 0.0446, u'long_stay_per_user': 0.9451, 'play_num':12, 'string_test':'hello'}
    date_time = dt(1995, 9, 20)
    put_indicator(metrics, date_time, 'hour', 'feed')

    # test increase_data
    metrics = {u'read_per_impr': 0.0446, u'long_stay_per_user': 0.9451, 'play_num':12}
    date_time = dt(1995, 9, 20)
    put_indicator(metrics, date_time, 'hour', 'feed', incremental=True)

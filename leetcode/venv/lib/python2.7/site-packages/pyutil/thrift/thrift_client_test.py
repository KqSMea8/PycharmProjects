#!/usr/bin/env python
# -*- coding: utf-8 -*-
import socket

from nose import tools

from pyutil.consul import discovery
from pyutil.thrift import thrift_client

TEST_CONSUL_NAME = "pyutil.thrift_client_test"
TEST_CONSUL_PORT = 8888
TEST_CONSUL_TAGS = []
localhost = socket.gethostbyname(socket.gethostname())

sd = discovery.ServiceDiscovery()
cli = thrift_client.ThriftRetryClient(thrift_client.ThriftClient, None, service_name="dummy")

def register():
    tools.ok_(sd)
    tools.ok_(sd.bring_up(TEST_CONSUL_NAME, TEST_CONSUL_PORT, TEST_CONSUL_TAGS))
    tools.ok_(cli)

@tools.with_setup(register)
def test_get_consul_servers():
    endpoints = cli._get_consul_servers(TEST_CONSUL_NAME)
    tools.ok_(len(endpoints) > 0)
    tools.assert_in((localhost, TEST_CONSUL_PORT), endpoints)

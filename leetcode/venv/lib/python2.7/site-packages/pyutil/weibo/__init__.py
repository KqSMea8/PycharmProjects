import re, pdb
from pyutil.program.conf import Conf
conf = Conf('/opt/tiger/ss_conf/ss/db_accountdb.conf')

from api.api import SinaAPI, TencentAPI

MAX_RETRY = 3
sina_api = SinaAPI(conf)
tencent_api = TencentAPI(conf)

EXPANDABLE_REGEXES = dict(
        sina=r'^http://t\.cn\/\w+',
        tencent=r'http://url\.cn\/(\w+)',
        )

def url_expandable(url):
    '''
    >>> url_expandable('http://t.cn/sdfds')
    sina
    >>> url_expandable('http://url.cn/sdfdse')
    tencent
    >>> url_expandable('http://url.cn/sdfdsex')
    False
    >>> url_expandable('http://xurl.cn/sdfds')
    False
    '''
    for by, regex in EXPANDABLE_REGEXES.items():
        m = re.search(regex, url)
        if m:
            if by == 'tencent' and len(m.group(1)) != 6:
                return False
            return by
    return False

def url_shorten(url):
    for i in range(MAX_RETRY):
        try:
            result = sina_api.short_url__shorten(url_long=url)
            return result['urls'][0]['url_short']
        except:
            continue
    raise

def url_expand(url):
    if re.search(EXPANDABLE_REGEXES['sina'], url):
        for i in range(MAX_RETRY):
            try:
                result = sina_api.short_url__expand(url_short=url)
                return result['urls'][0]['url_long']
            except:
                continue
        raise
    else:
        match = re.search(EXPANDABLE_REGEXES['tencent'], url)
        if match:
            short_url = match.group(1)
            if len(short_url) != 6:
                return None
            for i in range(MAX_RETRY):
                try:
                    result = tencent_api.short_url__expand(short_url=short_url)
                    return result['data']['long_url']
                except:
                    continue
            raise
    return None


if __name__ == '__main__':
    print url_expand('http://t.cn/zYVX669')
    print url_expand('http://url.cn/2HPSvl')
    print url_shorten('http://wiki.open.t.qq.com/index.php/API%E6%96%87%E6%A1%A3')
    #import pdb;pdb.set_trace()
    #print url_shorten('http://www.xiangping.com/detail/e91764206/')
    print url_expand('http://url.cn/CkolJ22')
    print url_expand('http://url.cn/BSe5vu')
    print url_expand('http://t.cn/zlBoJY8')
    #for i in range(20):
    #    print weibo_util._get_access_token()
